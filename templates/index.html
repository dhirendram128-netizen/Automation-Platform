{% extends "base.html" %}

{% block content %}

<h2 class="section-title">Available Automation Tools</h2>

<div class="tools-grid">

    <!-- INVOICE TOOL -->
    <div class="tool-card">
        <h3>Invoice Automation</h3>
        <p>Upload CSV and generate invoice ZIP.</p>

        <input type="file" id="invoiceFile" accept=".csv">
        <p class="hint">Max file size: 20 MB</p>

        <button onclick="submitInvoice()">Generate</button>

        <!-- LOCK + PAYMENT -->
        <div id="invoiceLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>
            <button id="invoicePayBtn" disabled>Pay â‚¹49</button>
        </div>
    </div>

    <!-- CSV CLEANER -->
    <div class="tool-card">
        <h3>CSV Cleaner</h3>
        <p>Clean messy CSV files instantly.</p>

        <input type="file" id="csvFile" accept=".csv">
        <button onclick="submitCSV()">Clean CSV</button>

        <div id="csvLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>
            <button id="csvPayBtn" disabled>Pay â‚¹49</button>
        </div>
    </div>

    <!-- PDF TO EXCEL -->
    <div class="tool-card">
        <h3>PDF to Excel</h3>
        <p>Extract tables from PDF.</p>

        <input type="file" id="pdfFile" accept=".pdf">
        <button onclick="submitPDF()">Convert PDF</button>

        <div id="pdfLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>
            <button id="pdfPayBtn" disabled>Pay â‚¹49</button>
        </div>
    </div>

</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let currentFilePath = "";
let currentTool = "";

/* ---------------- INVOICE ---------------- */

async function submitInvoice() {
    const file = document.getElementById("invoiceFile").files[0];
    if (!file) return alert("Select CSV file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/invoice", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        currentFilePath = data.file_path;
        currentTool = "invoice";
        document.getElementById("invoiceLock").style.display = "block";
        document.getElementById("invoicePayBtn").disabled = false;
    } else {
        alert("Invoice generation failed");
    }
}

/* ---------------- CSV CLEANER ---------------- */

async function submitCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Select CSV file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/csv-cleaner", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        currentFilePath = data.file_path;
        currentTool = "csv";
        document.getElementById("csvLock").style.display = "block";
        document.getElementById("csvPayBtn").disabled = false;
    } else {
        alert("CSV cleaning failed");
    }
}

/* ---------------- PDF ---------------- */

async function submitPDF() {
    const file = document.getElementById("pdfFile").files[0];
    if (!file) return alert("Select PDF file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/pdf-to-excel", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        currentFilePath = data.file_path;
        currentTool = "pdf";
        document.getElementById("pdfLock").style.display = "block";
        document.getElementById("pdfPayBtn").disabled = false;
    } else {
        alert("PDF conversion failed");
    }
}

/* ---------------- PAYMENT ---------------- */

async function startPayment() {
    const res = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            amount: 49,
            tool: currentTool,
            file_path: currentFilePath
        })
    });

    const order = await res.json();

    const options = {
        key: order.key,
        amount: order.amount,
        currency: "INR",
        name: "Automation Platform",
        description: "File Download",
        order_id: order.order_id,
        handler: function () {
            alert("Payment successful. Download will start.");
        }
    };

    new Razorpay(options).open();
}

document.getElementById("invoicePayBtn").onclick = startPayment;
document.getElementById("csvPayBtn").onclick = startPayment;
document.getElementById("pdfPayBtn").onclick = startPayment;
</script>

{% endblock %}
