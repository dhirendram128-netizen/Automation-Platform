{% extends "base.html" %}

{% block content %}

<h2 class="section-title">Available Automation Tools</h2>

<div class="tools-grid">

    <!-- INVOICE TOOL -->
    <div class="tool-card">
        <h3>Invoice Automation</h3>
        <p>Upload CSV and generate invoice ZIP.</p>

        <input type="file" id="invoiceFile" accept=".csv">
        <p class="hint">Max file size: 20 MB</p>

        <button type="button" onclick="submitInvoice()">Generate</button>

        <!-- LOCK + PAYMENT -->
        <div id="invoiceLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>

            <button type="button" id="invoicePayBtn" disabled>Pay â‚¹49</button>

            <!-- DOWNLOAD (hidden initially) -->
            <button type="button"
                    id="invoiceDownloadBtn"
                    style="display:none; margin-top:8px;">
                Download File
            </button>
        </div>
    </div>

    <!-- CSV CLEANER -->
    <div class="tool-card">
        <h3>CSV Cleaner</h3>
        <p>Clean messy CSV files instantly.</p>

        <input type="file" id="csvFile" accept=".csv">
        <button type="button" onclick="submitCSV()">Clean CSV</button>

        <div id="csvLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>
            <button type="button" id="csvPayBtn" disabled>Pay â‚¹49</button>
        </div>
    </div>

    <!-- PDF TO EXCEL -->
    <div class="tool-card">
        <h3>PDF to Excel</h3>
        <p>Extract tables from PDF.</p>

        <input type="file" id="pdfFile" accept=".pdf">
        <button type="button" onclick="submitPDF()">Convert PDF</button>

        <div id="pdfLock" style="display:none; margin-top:10px;">
            ðŸ”’ File ready. Pay â‚¹49 to download<br><br>
            <button type="button" id="pdfPayBtn" disabled>Pay â‚¹49</button>
        </div>
    </div>

</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let currentJobId = "";

/* ---------------- INVOICE ---------------- */

async function submitInvoice() {
    const file = document.getElementById("invoiceFile").files[0];
    if (!file) return alert("Select CSV file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/invoice", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        currentJobId = data.job_id;
        document.getElementById("invoiceLock").style.display = "block";
        document.getElementById("invoicePayBtn").disabled = false;
    } else {
        alert("Invoice generation failed");
    }
}

/* ---------------- CSV CLEANER ---------------- */

async function submitCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Select CSV file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/csv-cleaner", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        document.getElementById("csvLock").style.display = "block";
        document.getElementById("csvPayBtn").disabled = false;
    } else {
        alert("CSV cleaning failed");
    }
}

/* ---------------- PDF ---------------- */

async function submitPDF() {
    const file = document.getElementById("pdfFile").files[0];
    if (!file) return alert("Select PDF file");

    const fd = new FormData();
    fd.append("file", file);

    const res = await fetch("/pdf-to-excel", { method: "POST", body: fd });
    const data = await res.json();

    if (data.status === "ready") {
        document.getElementById("pdfLock").style.display = "block";
        document.getElementById("pdfPayBtn").disabled = false;
    } else {
        alert("PDF conversion failed");
    }
}

/* ---------------- PAYMENT ---------------- */

async function startPayment() {
    const res = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ job_id: currentJobId })
    });

    const order = await res.json();

    const options = {
        key: order.key,
        amount: order.amount,
        currency: "INR",
        name: "Automation Platform",
        description: "File Unlock",
        order_id: order.order_id,
        handler: function () {
            startPolling(currentJobId);
        }
    };

    new Razorpay(options).open();
}

/* ---------------- POLLING ---------------- */

function startPolling(jobId) {
    const interval = setInterval(async () => {
        const res = await fetch(`/check-status/${jobId}`);
        const data = await res.json();

        if (data.status === "paid") {
            clearInterval(interval);

            document.getElementById("invoicePayBtn").style.display = "none";

            const btn = document.getElementById("invoiceDownloadBtn");
            btn.style.display = "block";
            btn.onclick = () => {
                window.location.href = `/download/${jobId}`;
            };
        }
    }, 2000);
}

document.getElementById("invoicePayBtn").onclick = startPayment;
document.getElementById("csvPayBtn").onclick = startPayment;
document.getElementById("pdfPayBtn").onclick = startPayment;
</script>

{% endblock %}
